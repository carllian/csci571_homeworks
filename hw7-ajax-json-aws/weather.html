<html><head>
	<meta charset="utf-8">
  <title>HW8</title>
   
  <script src="http://yui.yahooapis.com/3.13.0/build/yui/yui-min.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.3.0/pure-min.css">
  <link rel="stylesheet" href="custom.css">
  
  <script language="javascript">

    $(document).ready(function() {
      $('#search-form').submit(function(event) {
        event.preventDefault(); // prevent page refresh
        
        // Check to make sure location was actually entered
        if((document.forms["search-form"]["location"].value=="") || (document.forms["search-form"]["location"].value==null)){ // check to make sure a location was entered
            window.alert("Please enter a location.");
            return false;
        }
        
        var city = false, zip = false;
        // Check to see if location is a valid city name
        var re = /^[A-Za-z]+[ ]*[A-Za-z]*,[ ]?[A-Za-z]{2,}(,[ ]?[A-Za-z]{2,})?$/;
        var match = re.exec(document.forms["search-form"]["location"].value);
        if (!match) { // the location isn't a city
          // Check to see if location is a valid zip code
          re = /^(?:\d{5})$/;
          var match = re.exec(document.forms["search-form"]["location"].value);
          if (!match) { // the location isn't a zip code either
            window.alert("If searching for a zip code, ensure the zip code is composed of 5 numbers. If searching for a city, ensure the city name is followed by a comma and a state or country.");
            return false;
          }
          else {
            zip = true;
          }
        }
        else {
          city = true;
        }
        
        var location = document.forms["search-form"]["location"].value;
        location = location.replace(/ /g, '+');
        var url = "http://cs-server.usc.edu:65223/examples/servlet/weathersearch?location=";
        if (city) {
          url = url + location + "&type=city&tempUnit=f";
        }
        else {
          url = url + location + "&type=zip&tempUnit=f";
        }
        var jsonStr;
      
        $.ajax({
          type: 'GET',
          url: url, 
          success: function(response){
            try {
              var jsonObject = JSON.parse(response);
            } catch(e){
               console.error("Parsing error:", e);
               alert("Invalid JSON string.");
            }
            if(jsonObject.weather){
              YUI().use('node', function(Y){
                if (jsonObject.weather.location.city) {
                  Y.one('#city-label').set("innerHTML", "<h1>" + jsonObject.weather.location.city + "</h1>");
                }
                if (jsonObject.weather.location.region) {
                  Y.one('#state-country-label').set("innerHTML", "<h4>" + jsonObject.weather.location.region + ", " + jsonObject.weather.location.country + "</h4>");
                }
                else {
                  Y.one('#state-country-label').set("innerHTML", "<h4>" + jsonObject.weather.location.country + "</h4>");
                }
                if (jsonObject.weather.img && jsonObject.weather.condition.text) {
                  Y.one('#weather-image').set("innerHTML", "<img src=\"" + jsonObject.weather.img + "\"><h4>" + jsonObject.weather.condition.text + "</h4>");
                }
                else if (jsonObject.weather.img) {
                  Y.one('#weather-image').set("innerHTML", "<img src=\"" + jsonObject.weather.img + "\">");
                }
                else if (jsonObject.weather.condition.text) {
                  Y.one('#weather-image').set("innerHTML", "<h6>" + jsonObject.weather.condition.text + "</h6>");
                }
                Y.one('#forecast-label').set("innerHTML", "<h3>Forecast</h3>");
              });
              
              YUI().use('datatable', function(Y) {
                Y.one('#forecast-table').set("innerHTML", "");
                var table = new Y.DataTable({
                  columns: ["Day", "Weather", "High", "Low"],
                  data: jsonObject.weather.forecast
                });
                
                table.render("#forecast-table");
              });
            }
            else { // No results found
              YUI().use('node', function(Y){
                Y.one('#results').set("innerHTML", "<h1>Weather information cannot be found!</h1>");
              });
            }
          }
        });

        return false;
      });
    });  
  </script>
				
</head><body>
    <form class="pure-form" name="search-form" id="search-form">
      <span class="label">Location:</span><input class="input-large" type="text" name="location" placeholder="City name or zip code...">
      <input type="submit" class="pure-button" value="Search"><!-- onclick="validate()" Search</button>-->
    </form><br><br><br>
    <div id="results"></div>
    <div id="city-label"></div>
    <div id="state-country-label"></div>
    <div class="pure-g">
      <div class="pure-u-1-3">
        <div id="weather-image"></div>
        <div id="temperature-buttons"></div>
        <div id="temperature"></div>
      </div>
      <div class="pure-u-1-3">
        <div id="forecast-label"></div>
        <div class="example yui3-skin-sam">
          <div id="forecast-table"></div>
        </div>
      </div>
      <div class="pure-u-1-3">
        facebook
      </div>
    </div>
    
</body></html>

